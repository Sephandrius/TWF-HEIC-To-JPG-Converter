<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T.W. FRIERSON HEIC Converter</title>
  
  <!-- Responsive styling -->
  <style>
    :root {
      /* T.W. Frierson brand colors from the guide */
      --4am: #333333; /* Black/4AM */
      --hardhat: #EBC42E; /* Yellow/HARDHAT */
      --blue-collar: #30526E; /* Blue/BLUE COLLAR */
      --brick: #BA6E4D; /* Brick color */
      --concrete: #D1CCC7; /* Concrete color */
      --reflector: #FAF7F5; /* White/REFLECTOR */
      
      /* Dark mode adaptations of the brand colors */
      --dark-bg: #1F1F1F;
      --darker-bg: #151515;
      --lighter-bg: #2A2A2A;
      --border-color: #444444;
      --text-color: var(--reflector);
      --text-secondary: #BBBBBB;
    }
    
    body {
      font-family: 'Franklin Gothic', 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
      max-width: 850px;
      margin: 0 auto;
      padding: 30px;
      color: var(--text-color);
      line-height: 1.6;
      background-color: var(--darker-bg);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: var(--hardhat);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tagline {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .container {
      background-color: var(--dark-bg);
      border-radius: 6px;
      padding: 35px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    
    .drop-area {
      border: 2px dashed var(--hardhat);
      border-radius: 6px;
      padding: 40px 25px;
      text-align: center;
      margin-bottom: 25px;
      background-color: var(--lighter-bg);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .drop-area:hover {
      background-color: #252525;
      border-color: var(--hardhat);
    }
    
    .drop-area.highlight {
      background-color: #222222;
      border-color: var(--hardhat);
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .file-input,
    .folder-input {
      display: none;
    }
    
    .upload-button {
      background-color: var(--hardhat);
      color: var(--4am);
      border: none;
      padding: 12px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 120px;
    }
    
    .upload-button:hover {
      background-color: #D9B52A;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .convert-button {
      display: block;
      background-color: var(--blue-collar);
      color: var(--reflector);
      border: none;
      padding: 14px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 25px auto;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      max-width: 250px;
      width: 100%;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .convert-button:hover {
      background-color: #3A6082;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .convert-button:disabled {
      background-color: #444444;
      color: #999999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .progress-container {
      margin-top: 25px;
      display: none;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #333333;
      border-radius: 5px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: var(--hardhat);
      width: 0%;
      transition: width 0.3s;
      border-radius: 5px;
    }
    
    .status {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
    }
    
    .file-list {
      margin-top: 25px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      background-color: var(--dark-bg);
    }
    
    .folder-item {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      color: var(--hardhat);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .file-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }
    
    .file-item:hover {
      background-color: #2A2A2A;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .folder-name {
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 5px;
      color: var(--hardhat);
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .security-notice {
      margin-top: 30px;
      background-color: rgba(186, 110, 77, 0.15);
      border-radius: 4px;
      padding: 15px 20px;
      border-left: 4px solid var(--brick);
    }
    
    .security-notice h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--brick);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .security-notice p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--darker-bg);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555555;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 20px;
      }
      
      .drop-area {
        padding: 30px 15px;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 24px;
      }
      
      .tagline {
        font-size: 14px;
      }
      
      .upload-button, .convert-button {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .convert-button {
        max-width: 220px;
      }
    }
  </style>
</head>
<body>
  <h1>T.W. FRIERSON</h1>
  <p class="tagline">HEIC to JPG Conversion Tool</p>
  
  <div class="container">
    <div id="drop-area" class="drop-area">
      <p>Drag & drop HEIC files or a folder containing HEIC files here</p>
      <div class="button-group">
        <input type="file" id="file-input" class="file-input" accept=".heic,.HEIC" multiple>
        <input type="file" id="folder-input" class="folder-input" webkitdirectory directory multiple>
        <button class="upload-button" onclick="document.getElementById('file-input').click()">Select Files</button>
        <button class="upload-button" onclick="document.getElementById('folder-input').click()">Select Folder</button>
      </div>
    </div>
    
    <div id="file-list" class="file-list" style="display: none;"></div>
    
    <button id="convert-btn" class="convert-button" disabled>Convert to JPG</button>
    
    <div id="progress-container" class="progress-container">
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
      <div id="status" class="status">Processing files...</div>
    </div>
    
    <div class="security-notice">
      <h3>No Surprises</h3>
      <p>This tool operates entirely within your browser. No files are uploaded to external servers, making it safe for confidential company documents and images. Your data never leaves your device.</p>
      <p>Created for T.W. Frierson by Joseph Winters.</p>
    </div>
  </div>

  <!-- Load required libraries from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Files storage
      let files = [];
      let sourceName = "";
      
      // Elements
      const dropArea = document.getElementById('drop-area');
      const fileInput = document.getElementById('file-input');
      const folderInput = document.getElementById('folder-input');
      const fileList = document.getElementById('file-list');
      const convertBtn = document.getElementById('convert-btn');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress');
      const statusText = document.getElementById('status');
      
      // -------- Event listeners --------
      
      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      // Highlight drop area when item is dragged over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      // Handle dropped files/folders
      dropArea.addEventListener('drop', handleDrop, false);
      
      // Handle selected files
      fileInput.addEventListener('change', handleFiles, false);
      
      // Handle selected folders
      folderInput.addEventListener('change', handleFolder, false);
      
      // Convert button event
      convertBtn.addEventListener('click', convertFiles, false);
      
      // -------- Utility functions --------
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight() {
        dropArea.classList.add('highlight');
      }
      
      function unhighlight() {
        dropArea.classList.remove('highlight');
      }
      
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // -------- File handling functions --------
      
      // Handle drag and drop
      function handleDrop(e) {
        const dt = e.dataTransfer;
        
        // Check for folders first
        if (dt.items) {
          const items = dt.items;
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.kind === 'file' && item.webkitGetAsEntry) {
              const entry = item.webkitGetAsEntry();
              if (entry && entry.isDirectory) {
                processDirectory(entry);
                return;
              }
            }
          }
        }
        
        // If no folders, process as regular files
        const droppedFiles = dt.files;
        handleFiles({ target: { files: droppedFiles } });
      }
      
      // Process individual files
      function handleFiles(e) {
        const inputFiles = e.target.files;
        
        if (!inputFiles || inputFiles.length === 0) {
          return;
        }
        
        // Filter only HEIC files
        const heicFiles = Array.from(inputFiles).filter(file => 
          file.name.toLowerCase().endsWith('.heic')
        );
        
        if (heicFiles.length === 0) {
          alert('Please select HEIC files only.');
          return;
        }
        
        // Store files with metadata
        sourceName = "Selected Files";
        files = heicFiles.map(file => {
          return {
            file: file,
            path: "", // No path for individual files
            fullPath: file.name,
            // Generate a unique ID for this file
            id: Math.random().toString(36).substring(2, 11)
          };
        });
        
        updateFileList();
        
        // Enable convert button
        convertBtn.disabled = files.length === 0;
      }
      
      // Process folder selection
      function handleFolder(e) {
        const inputFiles = e.target.files;
        
        if (!inputFiles || inputFiles.length === 0) {
          return;
        }
        
        // Filter only HEIC files
        const heicFiles = Array.from(inputFiles).filter(file => 
          file.name.toLowerCase().endsWith('.heic')
        );
        
        if (heicFiles.length === 0) {
          alert('No HEIC files found in the selected folder.');
          return;
        }
        
        // Get folder name from the path of the first file
        const pathParts = heicFiles[0].webkitRelativePath.split('/');
        sourceName = pathParts[0];
        
        // Store files with their relative paths
        files = heicFiles.map(file => {
          // Get the path excluding the root folder and filename
          const fullPath = file.webkitRelativePath;
          const pathParts = fullPath.split('/');
          pathParts.shift(); // Remove the root folder name
          
          // If there's just one part left, it's a file directly in the root
          const relativePath = pathParts.length > 1 ? 
            pathParts.slice(0, -1).join('/') : 
            '';
          
          return {
            file: file,
            path: relativePath,
            fullPath: pathParts.join('/'), // This no longer includes the root folder
            // Generate a unique ID for this file
            id: Math.random().toString(36).substring(2, 11)
          };
        });
        
        updateFileList();
        
        // Enable convert button
        convertBtn.disabled = files.length === 0;
      }
      
      // Process directories (for drag & drop)
      async function processDirectory(directoryEntry) {
        sourceName = directoryEntry.name;
        files = [];
        
        try {
          const entries = await readDirectoryEntries(directoryEntry);
          const heicFiles = await processEntries(entries, "");
          
          if (heicFiles.length === 0) {
            alert('No HEIC files found in the folder.');
            return;
          }
          
          files = heicFiles;
          updateFileList();
          
          // Enable convert button
          convertBtn.disabled = files.length === 0;
        } catch (error) {
          console.error("Error processing directory:", error);
          alert('Error reading folder: ' + error.message);
        }
      }
      
      // Read all entries in a directory recursively
      async function readDirectoryEntries(directoryEntry) {
        const directoryReader = directoryEntry.createReader();
        let entries = [];
        let readEntries = await readEntriesBatch(directoryReader);
        
        while (readEntries.length > 0) {
          entries = entries.concat(readEntries);
          readEntries = await readEntriesBatch(directoryReader);
        }
        
        return entries;
      }
      
      // Read a batch of entries from a directory reader
      function readEntriesBatch(directoryReader) {
        return new Promise((resolve, reject) => {
          directoryReader.readEntries(resolve, reject);
        });
      }
      
      // Process entries recursively
      async function processEntries(entries, path) {
        const files = [];
        
        for (const entry of entries) {
          if (entry.isFile) {
            if (entry.name.toLowerCase().endsWith('.heic')) {
              try {
                const file = await getFileFromEntry(entry);
                files.push({
                  file: file,
                  path: path, // Path without the root folder name
                  fullPath: path ? path + '/' + file.name : file.name,
                  id: Math.random().toString(36).substring(2, 11)
                });
              } catch (error) {
                console.error(`Error getting file ${entry.name}:`, error);
              }
            }
          } else if (entry.isDirectory) {
            try {
              const subEntries = await readDirectoryEntries(entry);
              const newPath = path ? path + '/' + entry.name : entry.name;
              const subFiles = await processEntries(subEntries, newPath);
              files.push(...subFiles);
            } catch (error) {
              console.error(`Error processing directory ${entry.name}:`, error);
            }
          }
        }
        
        return files;
      }
      
      // Get file from FileEntry
      function getFileFromEntry(fileEntry) {
        return new Promise((resolve, reject) => {
          fileEntry.file(resolve, reject);
        });
      }
      
      // Update the file list display
      function updateFileList() {
        if (files.length === 0) {
          fileList.style.display = 'none';
          return;
        }
        
        fileList.style.display = 'block';
        fileList.innerHTML = '';
        
        const titleElement = document.createElement('div');
        titleElement.className = 'folder-name';
        titleElement.textContent = sourceName;
        fileList.appendChild(titleElement);
        
        // Note about output structure
        const outputNote = document.createElement('div');
        outputNote.style.margin = '10px 0';
        outputNote.style.fontSize = '14px';
        outputNote.style.color = '#BBBBBB';
        outputNote.textContent = 'All files will be placed in a ZIP folder for download';
        fileList.appendChild(outputNote);
        
        // Display all files in a flat list
        files.forEach((fileInfo) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          
          // Show the output filename with folder prefix if needed
          let outputName = fileInfo.file.name.replace(/\.heic$/i, '.jpg');
          if (fileInfo.path) {
            const pathParts = fileInfo.path.split('/');
            const lastFolder = pathParts[pathParts.length - 1];
            outputName = lastFolder ? lastFolder + '_' + outputName : outputName;
          }
          
          // Show original path and output name
          fileItem.innerHTML = `
            <div><small>${fileInfo.path ? fileInfo.path + '/' : ''}${fileInfo.file.name}</small></div>
            <div>${outputName} (${formatFileSize(fileInfo.file.size)})
              <span style="float: right; cursor: pointer; color: #BA6E4D;" 
                    onclick="removeFile('${fileInfo.id}')">✕</span>
            </div>
          `;
          fileList.appendChild(fileItem);
        });
      }
      
      // Remove a file from the list
      window.removeFile = function(fileId) {
        files = files.filter(file => file.id !== fileId);
        updateFileList();
        convertBtn.disabled = files.length === 0;
      };
      
      // -------- Conversion functions --------
      
      // Convert files to JPG and create a ZIP
      async function convertFiles() {
        if (files.length === 0) return;
        
        // Show progress
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusText.textContent = 'Preparing to convert...';
        convertBtn.disabled = true;
        
        try {
          // Create a new JSZip instance
          const zip = new JSZip();
          
          // Process each file
          let processed = 0;
          let totalFiles = files.length;
          
          for (const fileInfo of files) {
            // Update status
            processed++;
            statusText.textContent = `Converting ${processed} of ${totalFiles}: ${fileInfo.file.name}`;
            progressBar.style.width = `${(processed / totalFiles) * 90}%`;
            
            try {
              // Convert HEIC to JPEG using heic2any
              const jpegBlob = await heic2any({
                blob: fileInfo.file,
                toType: 'image/jpeg',
                quality: 0.9
              });
              
              // Get file name without extension and add jpg extension
              let outputName = fileInfo.file.name.replace(/\.heic$/i, '') + '.jpg';
              
              // Add folder prefix if from a subfolder
              if (fileInfo.path) {
                const pathParts = fileInfo.path.split('/');
                const lastFolder = pathParts[pathParts.length - 1];
                if (lastFolder) {
                  outputName = lastFolder + '_' + outputName;
                }
              }
              
              // Add to zip
              zip.file(outputName, jpegBlob);
            } catch (err) {
              console.error(`Error converting ${fileInfo.file.name}:`, err);
              statusText.textContent = `Error with ${fileInfo.file.name}: ${err.message || 'Conversion failed'}`;
              await new Promise(resolve => setTimeout(resolve, 1500)); // Show error briefly before continuing
            }
          }
          
          // Update status
          statusText.textContent = 'Creating ZIP file...';
          progressBar.style.width = '90%';
          
          // Generate the ZIP file
          const zipBlob = await zip.generateAsync({ 
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 6 }
          }, (metadata) => {
            progressBar.style.width = `${90 + metadata.percent / 10}%`;
          });
          
          // Save the ZIP file using FileSaver.js
          saveAs(zipBlob, 'converted_images.zip');
          
          // Update status
          statusText.textContent = 'Conversion completed!';
          progressBar.style.width = '100%';
          
          // Reset after a delay
          setTimeout(() => {
            progressContainer.style.display = 'none';
            convertBtn.disabled = false;
          }, 3000);
          
        } catch (error) {
          console.error('Conversion error:', error);
          statusText.textContent = `Error: ${error.message || 'Failed to convert files'}`;
          convertBtn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>
