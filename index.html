<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEIC to JPG Folder Converter</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    .container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .drop-area {
      border: 2px dashed #3498db;
      border-radius: 5px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      background-color: #f0f8ff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .drop-area.highlight {
      background-color: #d6eaf8;
    }
    
    .folder-input {
      display: none;
    }
    
    .upload-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .upload-button:hover {
      background-color: #2980b9;
    }
    
    .convert-button {
      display: block;
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px auto;
      transition: background-color 0.3s;
    }
    
    .convert-button:hover {
      background-color: #27ae60;
    }
    
    .convert-button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #ecf0f1;
      border-radius: 5px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: #3498db;
      width: 0%;
      transition: width 0.3s;
    }
    
    .status {
      font-size: 14px;
      color: #7f8c8d;
      text-align: center;
    }
    
    .file-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ecf0f1;
      border-radius: 5px;
      padding: 10px;
    }
    
    .folder-item {
      padding: 5px 10px;
      border-bottom: 1px solid #ecf0f1;
      font-weight: bold;
    }
    
    .file-item {
      padding: 5px 10px 5px 25px;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .info {
      margin-top: 30px;
      font-size: 14px;
      color: #7f8c8d;
      text-align: center;
    }
    
    .folder-name {
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>HEIC to JPG Folder Converter</h1>
  
  <div class="container">
    <div id="drop-area" class="drop-area">
      <p>Drag & drop a folder containing HEIC files here or</p>
      <input type="file" id="folder-input" class="folder-input" webkitdirectory directory multiple>
      <button class="upload-button" onclick="document.getElementById('folder-input').click()">Select Folder</button>
    </div>
    
    <div id="file-list" class="file-list" style="display: none;"></div>
    
    <button id="convert-btn" class="convert-button" disabled>Convert to JPG</button>
    
    <div id="progress-container" class="progress-container">
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
      <div id="status" class="status">Processing files...</div>
    </div>
  </div>
  
  <div class="info">
    <p>This tool works entirely in your browser. No files are uploaded to any server.</p>
    <p>The converted images will be downloaded as a ZIP file with the original folder structure preserved.</p>
  </div>

  <!-- Load required libraries from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>

  <script>
    // Files storage with path information
    let folderFiles = [];
    let folderName = "";
    
    // Elements
    const dropArea = document.getElementById('drop-area');
    const folderInput = document.getElementById('folder-input');
    const fileList = document.getElementById('file-list');
    const convertBtn = document.getElementById('convert-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress');
    const statusText = document.getElementById('status');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped folders
    dropArea.addEventListener('drop', handleDrop, false);
    
    // Handle selected folders
    folderInput.addEventListener('change', handleFolder, false);
    
    // Convert button event
    convertBtn.addEventListener('click', convertFiles, false);
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight() {
      dropArea.classList.add('highlight');
    }
    
    function unhighlight() {
      dropArea.classList.remove('highlight');
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const items = dt.items;
      
      // Check if any folders were dropped
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file' && item.webkitGetAsEntry) {
          const entry = item.webkitGetAsEntry();
          if (entry.isDirectory) {
            processDirectory(entry);
            return;
          }
        }
      }
      
      // If no folders, process as regular files
      const files = dt.files;
      handleFolder({ target: { files } });
    }
    
    function processDirectory(directoryEntry) {
      folderName = directoryEntry.name;
      folderFiles = [];
      
      const reader = directoryEntry.createReader();
      readAllDirectoryEntries(reader, []).then(entries => {
        const heicFilesPromises = [];
        
        // Process all entries recursively
        processEntries(entries, "").then(files => {
          if (files.length === 0) {
            alert('No HEIC files found in the folder.');
            return;
          }
          
          folderFiles = files;
          updateFileList();
          
          // Enable convert button
          convertBtn.disabled = folderFiles.length === 0;
        });
      });
    }
    
    async function readAllDirectoryEntries(directoryReader, result) {
      let entries = await readEntriesPromise(directoryReader);
      if (entries.length) {
        result = result.concat(entries);
        return readAllDirectoryEntries(directoryReader, result);
      }
      return result;
    }
    
    function readEntriesPromise(directoryReader) {
      return new Promise((resolve, reject) => {
        directoryReader.readEntries(resolve, reject);
      });
    }
    
    async function processEntries(entries, path) {
      const files = [];
      
      for (const entry of entries) {
        if (entry.isFile) {
          if (entry.name.toLowerCase().endsWith('.heic')) {
            const file = await getFileFromEntry(entry);
            files.push({
              file: file,
              path: path,
              fullPath: path ? path + '/' + file.name : file.name
            });
          }
        } else if (entry.isDirectory) {
          const directoryReader = entry.createReader();
          const subEntries = await readAllDirectoryEntries(directoryReader, []);
          const newPath = path ? path + '/' + entry.name : entry.name;
          const subFiles = await processEntries(subEntries, newPath);
          files.push(...subFiles);
        }
      }
      
      return files;
    }
    
    function getFileFromEntry(fileEntry) {
      return new Promise((resolve, reject) => {
        fileEntry.file(resolve, reject);
      });
    }
    
    function handleFolder(e) {
      const files = Array.from(e.target.files);
      
      // Filter only HEIC files
      const heicFiles = files.filter(file => 
        file.name.toLowerCase().endsWith('.heic')
      );
      
      if (heicFiles.length === 0) {
        alert('No HEIC files found in the selected folder.');
        return;
      }
      
      // Get folder name from the path of the first file
      const pathParts = heicFiles[0].webkitRelativePath.split('/');
      folderName = pathParts[0];
      
      // Store files with their relative paths
      folderFiles = heicFiles.map(file => {
        // Get the path excluding the filename
        const fullPath = file.webkitRelativePath;
        const path = fullPath.substring(0, fullPath.lastIndexOf('/'));
        
        return {
          file: file,
          path: path,
          fullPath: fullPath
        };
      });
      
      updateFileList();
      
      // Enable convert button
      convertBtn.disabled = folderFiles.length === 0;
    }
    
    function updateFileList() {
      if (folderFiles.length === 0) {
        fileList.style.display = 'none';
        return;
      }
      
      fileList.style.display = 'block';
      fileList.innerHTML = '';
      
      const folderHeading = document.createElement('div');
      folderHeading.className = 'folder-name';
      folderHeading.textContent = `Folder: ${folderName}`;
      fileList.appendChild(folderHeading);
      
      // Group files by subfolder
      const folderStructure = {};
      
      folderFiles.forEach(fileInfo => {
        const path = fileInfo.path;
        if (!folderStructure[path]) {
          folderStructure[path] = [];
        }
        folderStructure[path].push(fileInfo);
      });
      
      // Display folder structure
      Object.keys(folderStructure).sort().forEach(path => {
        const displayPath = path.replace(folderName + '/', '');
        
        if (displayPath) {
          const folderItem = document.createElement('div');
          folderItem.className = 'folder-item';
          folderItem.textContent = `/${displayPath}`;
          fileList.appendChild(folderItem);
        }
        
        // Display files in this folder
        folderStructure[path].forEach(fileInfo => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.textContent = `${fileInfo.file.name} (${formatFileSize(fileInfo.file.size)})`;
          fileList.appendChild(fileItem);
        });
      });
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function convertFiles() {
      if (folderFiles.length === 0) return;
      
      // Show progress
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      statusText.textContent = 'Preparing to convert...';
      convertBtn.disabled = true;
      
      try {
        // Create a new JSZip instance
        const zip = new JSZip();
        
        // Process each file
        let processed = 0;
        let totalFiles = folderFiles.length;
        
        for (const fileInfo of folderFiles) {
          // Update status
          statusText.textContent = `Converting ${++processed} of ${totalFiles}: ${fileInfo.file.name}`;
          progressBar.style.width = `${(processed / totalFiles) * 90}%`;
          
          try {
            // Convert HEIC to JPEG using heic2any
            const jpegBlob = await heic2any({
              blob: fileInfo.file,
              toType: 'image/jpeg',
              quality: 0.9
            });
            
            // Get file name without extension and add jpg extension
            const fileName = fileInfo.file.name.replace(/\.heic$/i, '') + '.jpg';
            
            // Extract path relative to the root folder
            // This removes the initial folder name to avoid nested folders when extracting
            let relativePath = '';
            const pathParts = fileInfo.fullPath.split('/');
            
            if (pathParts.length > 1) {
              // Skip the first part (root folder name) and build the path
              pathParts.shift(); // Remove the root folder name
              relativePath = pathParts.join('/').replace(/\.heic$/i, '.jpg');
            } else {
              // If there's no slash, this is a file directly in the root
              relativePath = fileName;
            }
            
            // Add to zip without creating an extra root folder
            zip.file(relativePath, jpegBlob);
          } catch (err) {
            console.error(`Error converting ${fileInfo.file.name}:`, err);
            // Continue with other files
          }
        }
        
        // Update status
        statusText.textContent = 'Creating ZIP file...';
        progressBar.style.width = '90%';
        
        // Generate the ZIP file
        const zipBlob = await zip.generateAsync({ 
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        }, (metadata) => {
          progressBar.style.width = `${90 + metadata.percent / 10}%`;
        });
        
        // Save the ZIP file using FileSaver.js
        saveAs(zipBlob, `converted_images.zip`);
        
        // Update status
        statusText.textContent = 'Conversion completed!';
        progressBar.style.width = '100%';
        
        // Reset after a delay
        setTimeout(() => {
          progressContainer.style.display = 'none';
          convertBtn.disabled = false;
        }, 3000);
        
      } catch (error) {
        console.error('Conversion error:', error);
        statusText.textContent = `Error: ${error.message || 'Failed to convert files'}`;
        convertBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
